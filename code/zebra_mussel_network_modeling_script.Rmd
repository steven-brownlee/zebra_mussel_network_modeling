# Zebra mussel network modeling script

# Contact information

Contact: Steven Brownlee
Email: steven.fr.brownlee@gmail.com
Date last revised: June 24 2024

# Session info

R version 4.4.1 (2024-06-14)
Platform: x86_64-redhat-linux-gnu
Running under: Nobara Linux 40 (GNOME Edition)

Matrix products: default
BLAS/LAPACK: FlexiBLAS OPENBLAS-OPENMP;  LAPACK version 3.11.0

locale:
 [1] LC_CTYPE=en_CA.UTF-8      LC_NUMERIC=C              LC_TIME=en_CA.utf8       
 [4] LC_COLLATE=en_CA.UTF-8    LC_MONETARY=en_CA.utf8    LC_MESSAGES=en_CA.UTF-8  
 [7] LC_PAPER=en_CA.utf8       LC_NAME=C                 LC_ADDRESS=C             
[10] LC_TELEPHONE=C            LC_MEASUREMENT=en_CA.utf8 LC_IDENTIFICATION=C      

time zone: America/Vancouver
tzcode source: system (glibc)

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

loaded via a namespace (and not attached):
 [1] digest_0.6.36     tidyr_1.3.1       utf8_1.2.4        R6_2.5.1         
 [5] fastmap_1.2.0     tidyselect_1.2.1  xfun_0.46         magrittr_2.0.3   
 [9] glue_1.7.0        tibble_3.2.1      knitr_1.48        pkgconfig_2.0.3  
[13] htmltools_0.5.8.1 rmarkdown_2.27    dplyr_1.1.4       generics_0.1.3   
[17] lifecycle_1.0.4   cli_3.6.3         fansi_1.0.6       vctrs_0.6.5      
[21] compiler_4.4.1    purrr_1.0.2       rstudioapi_0.16.0 tools_4.4.1      
[25] pillar_1.9.0      evaluate_0.24.0   yaml_2.3.10       rlang_1.1.4   

# Set up data directory

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = '/home/steven/Documents/common/thesis/ch2/gis_data/')
```

# R library setup

```{r}
library(sf)
library(tidyverse)
library(rcartocolor)
library(sfnetworks)
library(qgisprocess)
library(future)
library(future.callr)
library(purrr)
library(furrr)
library(progressr)

```

# Import shapefiles

```{r}
zm_occurrences <- read_sf('data_directory/dreissenid_occurrences.gpkg')

us_major_cities_centroid <- read_sf('data_directory/cec_populated_places.gpkg') 

land <- read_sf('data_directory/cec_coastline.gpkg') 

lakes <- read_sf('data_directory/cec_lakes.gpkg') 

usdot_road_network <- read_sf('data_directory/usdot_road_network.gpkg')

qgis_bbox <- read_sf('data_directory/qgis_bbox.gpkg')

```


# Pre-processing

```{r}

zm_occurrences_proj <- st_transform(zm_occurrences, crs = 5070)

zm_10 <- st_buffer(zm_occurrences_proj, dist = 10000) %>% st_union() %>% st_as_sf() %>% 
  mutate(buffer_dist = '10 km')

zm_20 <- st_buffer(zm_occurrences_proj, dist = 20000) %>% st_union() %>% st_as_sf() %>% 
  mutate(buffer_dist = '20 km')

zm_30 <- st_buffer(zm_occurrences_proj, dist = 30000) %>% st_union() %>% st_as_sf() %>% 
  mutate(buffer_dist = '30 km')

zm_40 <- st_buffer(zm_occurrences_proj, dist = 40000) %>% st_union() %>% st_as_sf() %>% 
  mutate(buffer_dist = '40 km')

zm_50 <- st_buffer(zm_occurrences_proj, dist = 50000) %>% st_union() %>% st_as_sf() %>% 
  mutate(buffer_dist = '50 km')
 


 
zm_buffer_collected <- rbind(zm_50, zm_40, zm_30, zm_20, zm_10)

rm(zm_50, zm_40, zm_30, zm_20, zm_10)

zm_buffer_collected$buffer_dist <- factor(zm_buffer_collected$buffer_dist, levels = c('50 km', '40 km', '30 km', '20 km', '10 km'))

zm_buffer_collected <- st_transform(zm_buffer_collected, crs = 4326)

write_sf(zm_buffer_collected, 'data_directory/zm_buffer.gpkg')

```

# Load zm buffer

```{r}

zm_buffer_collected <- read_sf('data_directory/zm_buffer.gpkg')

```


```{r}

qgis_bbox_transformed <- qgis_bbox %>% st_transform(crs = 5070)

overlay_grid <- st_make_grid(qgis_bbox_transformed, cellsize = 2000, what = 'polygons',
                             square = FALSE) %>% st_as_sf() %>% st_transform(crs = 4326)

write_sf(overlay_grid, 'data_directory/2km_hexagon_grid.gpkg')

```

```{r}

overlay_grid <- read_sf('data_directory/2km_hexagon_grid.gpkg')

overlay_selection <- qgis_run_algorithm(
  "native:extractbylocation",
  INPUT = 'data_directory/2km_hexagon_grid.gpkg',
  PREDICATE = 6,
  INTERSECT = 'data_directory/cec_coastline.gpkg',
  OUTPUT = 'data_directory/2km_hexagon_selection.gpkg'
)

overlay_selection <- read_sf('data_directory/2km_hexagon_selection.gpkg')

write_sf(overlay_selection, 'data_directory/2km_hexagon_selection.gpkg', driver = 'GPKG')

```

# Read hexagon grid


```{r}

overlay_selection <- read_sf('data_directory/2km_hexagon_selection.gpkg') %>% 
  rowid_to_column('uid') 

overlay_centroids <- st_centroid(overlay_selection) %>% mutate(lon = sf::st_coordinates(.)[,1],
                lat = sf::st_coordinates(.)[,2])

overlay_centroids_joined <- st_join(overlay_centroids, overlay_selection)

write_sf(overlay_centroids_joined, 'data_directory/2km_centroids_joined.gpkg')

overlay_centroids <- overlay_centroids_joined %>% select(uid.y, lon, lat) %>% rename(uid = uid.y) %>% 
  st_drop_geometry()

write_rds(overlay_centroids, 'data_directory/2km_centroids_table.rds')

```

# Extract data from OpenStreetMap

```{r}

overlay_centroids <- readRDS('data_directory/2km_centroids_table.rds')

```
# d

# New workflow

```{r}

na_data <- read_sf('data_directory/na_highway_filtered_final.gpkg')

na_data <- na_data %>% select(-waterway, -aerialway, -barrier, -man_made, -z_order) 

na_data <- st_centroid(na_data)

na_data <- st_join(na_data, hexagon_dissolved)

write_sf(na_data, 'data_directory/na_highway_grouped.gpkg')

```



```{r}

na_data <- read_sf('data_directory/na_highway_filtered_final.gpkg') %>% 
  select(-waterway, -aerialway, -barrier, -man_made, -z_order) %>% rowid_to_column()

###

divided_dataset <- tibble(x = seq(1:18135029))

num_groups = 2000

divided_dataset <- divided_dataset %>% mutate(grouping = (row_number()-1) %/% (n()/num_groups)) %>% 
   group_by(grouping) %>% 
  summarize(min_x = min(x), max_x = max(x)) %>% select(-grouping)


sequence_start = pull(divided_dataset, min_x)

sequence_end = pull(divided_dataset, max_x)

for (i in 1:2000)  {
  group_slice <- na_data %>% 
    filter(rowid >= sequence_start[i] & rowid < sequence_end[i]) %>% 
    st_transform(crs = 'ESRI:102008')
  write_sf(group_slice, paste0('scratch/group_slice/group_slice_', i, '.gpkg'))
  print(paste('Completed:', i))
}

```

```{r}

osm_slice_list = list.files('/home/steven/Documents/common/thesis/ch2/gis_data/scratch/group_slice/', 
                      pattern = 'group_slice_*',
                      full.names = TRUE,
                      recursive = TRUE)

linesplit_small <- function(id, osm_file) {
  osm_filtered <- osm_file %>% filter(osm_id == id) 
  osm_interior_length <- osm_filtered$length
  osm_interpolated <- osm_filtered %>% st_as_sfc %>% 
  st_line_interpolate(dist = seq(0, osm_interior_length, osm_interior_length/2)) %>% st_as_sf() %>% 
    mutate(osm_id = as.character(id)) %>% mutate(lon = sf::st_coordinates(.)[,1],
                lat = sf::st_coordinates(.)[,2]) %>% st_drop_geometry()
  osm_aspatial <- osm_filtered %>% st_drop_geometry()
  osm_joined <- left_join(osm_interpolated, osm_filtered, by = 'osm_id')
  return(osm_joined)
}

linesplit_regular <- function(id, osm_file, maxlength) {
  osm_filtered <- osm_file %>% filter(osm_id == id) 
  osm_interior_length <- osm_filtered$length
  osm_interpolated <- osm_filtered %>% st_as_sfc %>% 
  st_line_interpolate(dist = seq(0, osm_interior_length, maxlength)) %>% st_as_sf() %>% 
    mutate(osm_id = as.character(id)) %>% mutate(lon = sf::st_coordinates(.)[,1],
                lat = sf::st_coordinates(.)[,2]) %>% st_drop_geometry()
  osm_aspatial <- osm_filtered %>% st_drop_geometry()
  osm_joined <- left_join(osm_interpolated, osm_filtered, by = 'osm_id')
  return(osm_joined)
}

  
outer_process <- function(osm_slice) {
  
  osm_interior <- read_sf(osm_slice)
  #
  osm_interior <- osm_interior %>% mutate(length = as.numeric(st_length(geom)))
  osm_less_1km <- osm_interior %>% filter(length < 1000)
  osm_greater_1km <- osm_interior %>% filter(length > 1000)
  #
  less_1km_ids <- unique(osm_less_1km$osm_id)
  greater_1km_ids <- unique(osm_greater_1km$osm_id)
  #
  p  <- progressr::progressor(along = less_1km_ids)
  less_1km_result <- future_map(less_1km_ids, 
                                globals = c(osm_interior = osm_interior),
    ~{ p()
    linesplit_small(.x, osm_file = osm_interior)})
  p  <- progressr::progressor(along = greater_1km_ids)
  greater_1km_result <- future_map(greater_1km_ids, 
                                globals = c(osm_interior = osm_interior),
    ~{ p()
    linesplit_regular(.x, osm_file = osm_interior, maxlength = 500)})
  less_1km_result <- bind_rows(less_1km_result)
  greater_1km_result <- bind_rows(greater_1km_result)
  final_results <- bind_rows(less_1km_result, greater_1km_result)
  return(final_results)
}


plan(callr, workers = 6)


for (i in 1:710) {
  with_progress({osm_processed <- outer_process(osm_slice_list[i])})
  osm_processed <- bind_rows(osm_processed)
  print(paste('Completed:', i))
  write_csv(osm_processed, paste0('scratch/point_outdir/osm_point_table_processed_', i ,'.csv'))
}

for (i in 711:1420) {
  with_progress({osm_processed <- outer_process(osm_slice_list[i])})
  osm_processed <- bind_rows(osm_processed)
  print(paste('Completed:', i))
  write_csv(osm_processed, paste0('scratch/point_outdir/osm_point_table_processed_', i ,'.csv'))
  gc()
}

for (i in 1420:2000) {
  with_progress({osm_processed <- outer_process(osm_slice_list[i])})    
  osm_processed <- bind_rows(osm_processed)
  print(paste('Completed:', i))
  write_csv(osm_processed, paste0('scratch/point_outdir/osm_point_table_processed_', i ,'.csv'))
}

hexagon_dissolved <- read_sf('data_directory/2km_hexagon_dissolved.gpkg')

osm_data_list = list.files('scratch/point_outdir/', 
                      pattern = 'osm_point_table_processed_*',
                      full.names = TRUE,
                      recursive = TRUE)


for (i in 1:length(osm_data_list))  {
 osm_point_intermediate <- read_csv(osm_data_list[i], show_col_types = FALSE)
 osm_point_intermediate <- st_as_sf(osm_point_intermediate, 
                                    coords = c('lon', 'lat'), 
                              crs = st_crs('ESRI:102008')) %>% 
   st_transform(crs = 4326)
 osm_point_intermediate <- st_join(osm_point_intermediate, hexagon_dissolved) 
 osm_point_intermediate <- osm_point_intermediate %>% 
   mutate(lon = sf::st_coordinates(.)[,1],
          lat = sf::st_coordinates(.)[,2]) %>% 
    st_drop_geometry()
 write_csv(osm_point_intermediate, paste0('scratch/point_outdir/osm_points_organized_', i, '.csv'))
 print(paste('Written:', i))
}


```


```{r}

osm_data_list = list.files('scratch/point_outdir/', 
                      pattern = 'osm_points_organized_*',
                      full.names = TRUE,
                      recursive = TRUE)


osm_filter <- function(input_table) {
  input_table <- read_csv(input_table, show_col_types = FALSE)
  combined_osm_table <- input_table %>% 
    rowid_to_column('point_id')
  combined_osm_table$name <- sub('^$', 'no_name', combined_osm_table$name)

  osm_table_ids <- combined_osm_table %>% select(point_id, osm_id, group_id, name, lon, lat)

  osm_table_lanes <- combined_osm_table %>% filter(grepl('lanes', other_tags)) %>% 
      separate_longer_delim(other_tags, delim = ',') %>%  
      filter(grepl('"lanes"=>', other_tags)) %>%  
      mutate(across('other_tags', str_replace, '"lanes"=>', '')) %>% 
      mutate(across('other_tags', str_replace, '"', '')) %>% 
      mutate(across('other_tags', str_replace, '"', '')) %>% 
      rename(lanes = other_tags) %>% select(point_id, osm_id, name, lanes) %>% 
      st_drop_geometry()

  
  osm_table_lanes <- osm_table_lanes

  osm_table_lanes$lanes <- sub("\\;.*", "", osm_table_lanes$lanes)

  osm_table_lanes$lanes <- gsub("[^0-9]", NA, osm_table_lanes$lanes)

  osm_table_lanes <- osm_table_lanes %>% drop_na()

  osm_table_lanes$lanes <- as.numeric(osm_table_lanes$lanes)

  ####

  osm_table_maxspeed <- combined_osm_table %>% filter(grepl('maxspeed', other_tags)) %>% 
      separate_longer_delim(other_tags, delim = ',')  %>% 
      filter(grepl('"maxspeed"=>', other_tags)) %>% 
      mutate(across('other_tags', str_replace, '"maxspeed"=>', ''))%>% 
      rename(max_speed = other_tags)  %>% 
      filter(!grepl('unposted', max_speed)) %>% 
      filter(!grepl('slow', max_speed)) %>% 
      filter(!grepl('implicit', max_speed)) %>% 
      filter(!grepl('default', max_speed)) %>% 
      filter(!grepl('signals', max_speed)) %>% 
      filter(!grepl('Variable', max_speed)) %>% 
      select(point_id, osm_id, max_speed)
  
  osm_table_maxspeed_kmh <- osm_table_maxspeed %>% 
      filter(!grepl('mph', max_speed) & !grepl('MPH', max_speed)) %>% 
      mutate(across('max_speed', str_replace, '"', '')) %>% 
      mutate(across('max_speed', str_replace, '"', ''))

  osm_table_maxspeed_kmh$max_speed <- sub("\\;.*", "", osm_table_maxspeed_kmh$max_speed)

  osm_table_maxspeed_kmh$max_speed <- gsub("[^0-9.-]", NA, osm_table_maxspeed_kmh$max_speed) 

  osm_table_maxspeed_kmh$max_speed <- as.numeric(osm_table_maxspeed_kmh$max_speed)
  
  osm_table_maxspeed_kmh <- osm_table_maxspeed_kmh %>% drop_na()

  ###

  osm_table_maxspeed_mph <- osm_table_maxspeed %>% filter(grepl('mph', max_speed)) %>% 
    mutate(across('max_speed', str_replace, ' mph', '')) %>%
    mutate(across('max_speed', str_replace, 'mph', ''))

  osm_table_maxspeed_mph$max_speed <- sub("\\;.*", "", osm_table_maxspeed_mph$max_speed)

  osm_table_maxspeed_mph <- osm_table_maxspeed_mph %>% 
    mutate(across('max_speed', str_replace, '"', '')) %>% 
    mutate(across('max_speed', str_replace, '"', '')) 

  osm_table_maxspeed_mph$max_speed <- as.numeric(osm_table_maxspeed_mph$max_speed)

  osm_table_maxspeed_mph <- osm_table_maxspeed_mph %>% drop_na()

  osm_table_maxspeed_mph <- osm_table_maxspeed_mph %>% 
    mutate(max_speed_kmh = max_speed*1.609344) %>% 
    select(point_id, osm_id, max_speed_kmh) %>% 
    rename(max_speed = max_speed_kmh)

  osm_table_maxspeed_combined <- rbind(osm_table_maxspeed_mph, osm_table_maxspeed_kmh)

  osm_table_maxspeed_combined <- osm_table_maxspeed_combined %>% 
    filter(max_speed < 120)


  ###

  osm_table_type <- combined_osm_table %>% select(point_id, osm_id, highway) %>% rename(type = highway)
  
  osm_table_type$type <- factor(osm_table_type$type, 
                                  levels = c('residential', 'unclassified', 
                                               'tertiary', 'secondary', 
                                               'primary', 'trunk', 'motorway'))

  osm_filtered_data <- left_join(osm_table_ids, osm_table_type, 
                               by = 'point_id',
                               relationship = 'one-to-one',
                               keep = FALSE)

  osm_filtered_data <- left_join(osm_filtered_data, osm_table_lanes, 
                               by = 'point_id',
                               relationship = 'one-to-one')

  osm_filtered_data <- left_join(osm_filtered_data, osm_table_maxspeed_combined, 
                               by = 'point_id',
                               relationship = 'one-to-one')
  osm_filtered_data <- osm_filtered_data %>% select(lon, lat, point_id, osm_id.x, group_id, 
                                         name.x, type, lanes, max_speed) %>% 
    rename(osm_id = osm_id.x, name = name.x)

  
  return(osm_filtered_data)
}


for (i in 1:2000) {
  ({osm_processed <- osm_filter(osm_data_list[i])})
  write_csv(osm_processed, paste0('scratch/filtered_outdir/osm_filtered_data_', i, '.csv'))
  print(paste('Completed:', i))
}

osm_data_list = list.files('scratch/', 
                      pattern = 'osm_filtered_data_*',
                      full.names = TRUE,
                      recursive = TRUE)

osm_combined <- osm_data_list %>% map(read_csv, show_col_types = FALSE) %>% bind_rows()

write_rds(osm_combined, 'scratch/osm_combined.rds')

#osm_combined <- readRDS('scratch/osm_combined.rds')


hexagon_north_america <- read_sf('data_directory/2km_hexagon_selection_grouped.gpkg')

for (i in 1:40) {
  osm_hexagon_aligned <- osm_combined %>% filter(group_id == i) %>% rowid_to_column()
  write_csv(osm_hexagon_aligned, paste0('scratch/osm_hexagon_grouped_csvs/hexagon_group_', i, '.csv'))
  print(paste('Finished reading data:', i))
  #
  divided_dataset <- tibble(x = seq(1:nrow(osm_hexagon_aligned)))
  num_groups = 10
  divided_dataset <- divided_dataset %>% mutate(grouping = (row_number()-1) %/% (n()/num_groups)) %>% 
   group_by(grouping) %>% summarize(min_x = min(x), max_x = max(x)) %>% select(-grouping)
  sequence_start = pull(divided_dataset, min_x)
  sequence_end = pull(divided_dataset, max_x)
  for (x in 1:10)  {
    group_slice <- osm_hexagon_aligned %>% 
      filter(rowid >= sequence_start[x] & rowid < sequence_end[x]) %>% 
      st_as_sf(coords = c('lon', 'lat'), crs = 4326)
    write_sf(group_slice, paste0('data_directory/osm_grouped/group_slice_section_', i,'_part_', x, '.gpkg'))
    print(paste('Completed: section', i, 'slice', x))
    }
}

for (i in 1:40) {
  hexagon_subset <- hexagon_north_america %>% filter(group_id == i)
  write_sf(hexagon_subset, paste0('data_directory/final_hexagon/osm_hexagon_aligned_', i, '.gpkg'))
  print(paste('Completed:', i))
}


```

```{r}

osm_data_list = list.files('data_directory/osm_grouped/', 
                      pattern = 'group_slice_section_*',
                      full.names = TRUE,
                      recursive = TRUE)


hexagon_north_america <- read_sf('data_directory/2km_hexagon_selection_grouped.gpkg')


inner_summarizer <- function(osm_file, hexagons) {
  osm_iterate <- read_sf(osm_file) %>%
    select(-rowid, -point_id)
  hexagon_joined <- st_join(hexagons, osm_iterate,
                               left = TRUE,
                               join = st_intersects) %>% 
        st_drop_geometry()
  hexagon_sum <- hexagon_joined %>% group_by(rowid) %>% 
        summarize_at(c('max_speed', 'type', 'lanes'),
                     max, na.rm = TRUE)
  return(hexagon_sum)
}





summarizer <- function(osm_list, hexagons) {
  p  <- progressr::progressor(along = osm_list)
  hexagons_joined <- future_map(osm_list,
    ~{ p()
    inner_summarizer(.x, hexagons = hexagons)},
    globals = c(hexagons = hexagons))
}

###

options(future.globals.maxSize = 1.5e+9)

plan(callr, workers = 6)

for (i in 1:40) {
  hexagon_selection <- read_sf(paste0('data_directory/final_hexagon/osm_hexagon_aligned_', i, '.gpkg'))
  osm_pattern <- paste0('group_slice_section_', i, '_*')
  osm_subsection = list.files('data_directory/osm_grouped/', 
                      pattern = osm_pattern,
                      full.names = TRUE,
                      recursive = TRUE)
  with_progress({osm_grouped <- summarizer(osm_subsection, hexagons = hexagon_selection)})
  osm_grouped <- bind_rows(osm_grouped)
  write_sf(osm_grouped, paste0('data_directory/final_osm_joined_hexagons/joined_hexagon_', i, '.gpkg'))
}

osm_hexagon_template <- tibble(rowid = numeric(),
                               max_speed = numeric(),
                               type = character(),
                               lanes = numeric()
)
                               
for (i in 1:40) {
  hexagon_selection <- read_sf(paste0('data_directory/final_hexagon/osm_hexagon_aligned_', i, '.gpkg'))
  osm_subsection = list.files('data_directory/osm_grouped/', 
                      pattern = osm_pattern,
                      full.names = TRUE,
                      recursive = TRUE)
  print(paste('Beginning subsection:', i))
  for (x in 1:10) {
    osm_iterate <- read_sf(osm_subsection[x]) %>%
    select(-rowid, -point_id)
    hexagon_joined <- st_join(hexagon_selection, osm_iterate,
                               left = TRUE,
                               join = st_intersects) %>% 
        st_drop_geometry()
    osm_hexagon_template <- bind_rows(osm_hexagon_template, hexagon_joined)
    print(paste('Completed subsection', i, 'group', x))
  }
  print(paste('Completed subsection:', i))
}

osm_hexagon_summarized <- osm_hexagon_template %>% select(-group_id.y) %>% 
  rename(group_id = group_id.x) %>% 
  group_by(rowid) %>% 
        summarize_at(c('max_speed', 'type', 'lanes'),
                     max, na.rm = TRUE)

hexagon_north_america <- read_sf('data_directory/2km_hexagon_selection_grouped.gpkg')

hexagon_north_america <- left_join()

```


# Cast lines between points

```{r}


# Credit: https://gis.stackexchange.com/questions/293658/creating-lines-between-pairs-of-points

library(tidyverse)
library(sf)

table_sf <- table %>%
  group_by(NOMBRE) %>%
  mutate(
    lineid = row_number(), # create a lineid
    LONG_end = lead(LONG), # create the end point coords for each start point
    LAT_end = lead(LAT)
  ) %>% 
  unite(start, LONG, LAT) %>% # collect coords into one column for reshaping
  unite(end, LONG_end, LAT_end) %>%
  filter(end != "NA_NA") %>% # remove nas (last points in a NOMBRE group don't start lines)
  gather(start_end, coords, start, end) %>% # reshape to long
  separate(coords, c("LONG", "LAT"), sep = "_") %>% # convert our text coordinates back to individual numeric columns
  mutate_at(vars(LONG, LAT), as.numeric) %>%
  st_as_sf(coords = c("LONG", "LAT")) %>% # create points
  group_by(NOMBRE, INT, lineid) %>%
  summarise() %>% # union points into lines using our created lineid
  st_cast("LINESTRING")

plot(table_sf[, 1:2])

```


```{r}

zm_bbox <- st_bbox(north_america_bbox)


buffer_plot <- ggplot() + geom_sf(data = land, fill = 'gray70', colour = 'gray15') +
  geom_sf(data = large_rivers, colour = 'gray60') +
  geom_sf(data = small_rivers, colour = 'gray60', alpha = 0.3) +
    geom_sf(data = large_lakes, fill = 'gray50', colour = 'gray15') +
  geom_sf(data = small_lakes, fill = 'gray50', colour = 'gray15') +
  geom_sf(data = zm_buffer_collected_test, aes(fill = buffer_dist)) +
  scale_fill_carto_d(palette = 'TealGrn', direction = -1, name = 'Buffer distance \n in km') +
  theme_dark(base_family = extrafont::choose_font('Cantarell Light'), 
               base_size = 12) +
      coord_sf(xlim = c(zm_bbox[[1]], zm_bbox[[3]]),
             ylim = c(zm_bbox[[2]], zm_bbox[[4]]), 
             expand = FALSE) 



```

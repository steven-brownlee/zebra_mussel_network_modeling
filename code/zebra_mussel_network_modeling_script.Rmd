# Zebra mussel network modeling script

# Contact information

Contact: Steven Brownlee
Email: steven.fr.brownlee@gmail.com
Date last revised: June 24 2024

# Session info

R version 4.4.1 (2024-06-14)
Platform: x86_64-redhat-linux-gnu
Running under: Nobara Linux 40 (GNOME Edition)

Matrix products: default
BLAS/LAPACK: FlexiBLAS OPENBLAS-OPENMP;  LAPACK version 3.11.0

locale:
 [1] LC_CTYPE=en_CA.UTF-8      LC_NUMERIC=C              LC_TIME=en_CA.utf8       
 [4] LC_COLLATE=en_CA.UTF-8    LC_MONETARY=en_CA.utf8    LC_MESSAGES=en_CA.UTF-8  
 [7] LC_PAPER=en_CA.utf8       LC_NAME=C                 LC_ADDRESS=C             
[10] LC_TELEPHONE=C            LC_MEASUREMENT=en_CA.utf8 LC_IDENTIFICATION=C      

time zone: America/Vancouver
tzcode source: system (glibc)

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

loaded via a namespace (and not attached):
 [1] digest_0.6.36     tidyr_1.3.1       utf8_1.2.4        R6_2.5.1         
 [5] fastmap_1.2.0     tidyselect_1.2.1  xfun_0.46         magrittr_2.0.3   
 [9] glue_1.7.0        tibble_3.2.1      knitr_1.48        pkgconfig_2.0.3  
[13] htmltools_0.5.8.1 rmarkdown_2.27    dplyr_1.1.4       generics_0.1.3   
[17] lifecycle_1.0.4   cli_3.6.3         fansi_1.0.6       vctrs_0.6.5      
[21] compiler_4.4.1    purrr_1.0.2       rstudioapi_0.16.0 tools_4.4.1      
[25] pillar_1.9.0      evaluate_0.24.0   yaml_2.3.10       rlang_1.1.4   

# Set up data directory

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = '/home/steven/Documents/common/thesis/ch2/gis_data/')
```

# R library setup

```{r}
library(sf)
library(tidyverse)
library(rcartocolor)
library(sfnetworks)
library(qgisprocess)
library(future)
library(doFuture)

```

# Import shapefiles

```{r}
zm_occurrences <- read_sf('data_directory/dreissenid_occurrences.gpkg')

us_major_cities_centroid <- read_sf('data_directory/cec_populated_places.gpkg') 

land <- read_sf('data_directory/cec_coastline.gpkg') 

lakes <- read_sf('data_directory/cec_lakes.gpkg') 

usdot_road_network <- read_sf('data_directory/usdot_road_network.gpkg')

qgis_bbox <- read_sf('data_directory/qgis_bbox.gpkg')

```


# Pre-processing

```{r}

zm_occurrences_proj <- st_transform(zm_occurrences, crs = 5070)

zm_10 <- st_buffer(zm_occurrences_proj, dist = 10000) %>% st_union() %>% st_as_sf() %>% 
  mutate(buffer_dist = '10 km')

zm_20 <- st_buffer(zm_occurrences_proj, dist = 20000) %>% st_union() %>% st_as_sf() %>% 
  mutate(buffer_dist = '20 km')

zm_30 <- st_buffer(zm_occurrences_proj, dist = 30000) %>% st_union() %>% st_as_sf() %>% 
  mutate(buffer_dist = '30 km')

zm_40 <- st_buffer(zm_occurrences_proj, dist = 40000) %>% st_union() %>% st_as_sf() %>% 
  mutate(buffer_dist = '40 km')

zm_50 <- st_buffer(zm_occurrences_proj, dist = 50000) %>% st_union() %>% st_as_sf() %>% 
  mutate(buffer_dist = '50 km')
 


 
zm_buffer_collected <- rbind(zm_50, zm_40, zm_30, zm_20, zm_10)

rm(zm_50, zm_40, zm_30, zm_20, zm_10)

zm_buffer_collected$buffer_dist <- factor(zm_buffer_collected$buffer_dist, levels = c('50 km', '40 km', '30 km', '20 km', '10 km'))

zm_buffer_collected <- st_transform(zm_buffer_collected, crs = 4326)

write_sf(zm_buffer_collected, 'data_directory/zm_buffer.gpkg')

```

# Load zm buffer

```{r}

zm_buffer_collected <- read_sf('data_directory/zm_buffer.gpkg')

```


```{r}

qgis_bbox_transformed <- qgis_bbox %>% st_transform(crs = 5070)

overlay_grid <- st_make_grid(qgis_bbox_transformed, cellsize = 2000, what = 'polygons',
                             square = FALSE) %>% st_as_sf() %>% st_transform(crs = 4326)

write_sf(overlay_grid, 'data_directory/2km_hexagon_grid.gpkg')

```

```{r}

overlay_grid <- read_sf('data_directory/2km_hexagon_grid.gpkg')

overlay_selection <- qgis_run_algorithm(
  "native:extractbylocation",
  INPUT = 'data_directory/2km_hexagon_grid.gpkg',
  PREDICATE = 6,
  INTERSECT = 'data_directory/cec_coastline.gpkg',
  OUTPUT = 'data_directory/2km_hexagon_selection.gpkg'
)

overlay_selection <- read_sf('data_directory/2km_hexagon_selection.gpkg')

write_sf(overlay_selection, 'data_directory/2km_hexagon_selection.gpkg', driver = 'GPKG')

```

# Read hexagon grid


```{r}

overlay_selection <- read_sf('data_directory/2km_hexagon_selection.gpkg') %>% 
  rowid_to_column('uid') 

overlay_centroids <- st_centroid(overlay_selection) %>% mutate(lon = sf::st_coordinates(.)[,1],
                lat = sf::st_coordinates(.)[,2])

overlay_centroids_joined <- st_join(overlay_centroids, overlay_selection)

write_sf(overlay_centroids_joined, 'data_directory/2km_centroids_joined.gpkg')

overlay_centroids <- overlay_centroids_joined %>% select(uid.y, lon, lat) %>% rename(uid = uid.y) %>% 
  st_drop_geometry()

write_rds(overlay_centroids, 'data_directory/2km_centroids_table.rds')

```

# Extract data from OpenStreetMap

```{r}

overlay_centroids <- readRDS('data_directory/2km_centroids_table.rds')

```
# 



```{r}

osm_extracter <- function(startpoint, endpoint, centroids) {

    entry_table <- tibble(uid = numeric(), lanes = numeric(), maxspeed = numeric(),
                      type = factor(levels = c('residential', 'unclassified', 
                                               'tertiary', 'secondary', 
                                               'primary', 'trunk', 'motorway')
                                    ))
    osm_colnames <- c('osm_id', 'name', 'highway', 'lanes', 'maxspeed')
  for (i in startpoint:endpoint)  {
  # Extract lat/lon information and OSM query
  query_coords <- centroids %>% filter(uid == i)
  q_lon <- as.numeric(query_coords$lon)
  q_lat <- as.numeric(query_coords$lat)
  osm_query <- opq_around(q_lon, q_lat, 
                          radius = 1000, 
                          timeout = 50, 
                          key = 'highway') %>%
  osmdata_sf()
  
  osm_query_filtered <- osm_query$osm_lines
  
  #print(paste('Query', x, 'retrieved! Assessing...'))
  
  # Only proceed to next step if all of needed column types are present, ------
  # if not write 'NA' in entry table 
  
  if (all((osm_colnames) %in% colnames(osm_query_filtered)) == TRUE) {
    
    # Filter for desired road types
    osm_query_filtered <- osm_query_filtered %>% 
       filter(highway == 'motorway' | highway == 'trunk' | 
                highway == 'primary' | highway == 'secondary' | 
                highway == 'tertiary' | highway == 'unclassified' |
                highway == 'residential')
    osm_query_filtered <- osm_query_filtered %>% select(lanes, maxspeed, highway)
     
    # Retrieve max lane numbers------------------------------------------------
    osm_query_filtered$lanes <- as.numeric(osm_query_filtered$lanes) 
    
    osm_query_lanes <- osm_query_filtered %>% select(lanes) %>% 
      st_drop_geometry() %>% drop_na() %>% max()
    
    # Pre-process speed data to remove 'mph', harmonize speeds in km/h --------
    osm_query_filtered <- osm_query_filtered %>% 
        mutate(mph = grepl('mph', osm_query_filtered$maxspeed))
    osm_query_filtered$maxspeed <- str_replace(osm_query_filtered$maxspeed, 
                                               'mph', '')
    osm_query_filtered$maxspeed <- as.numeric(osm_query_filtered$maxspeed)
    osm_query_filtered <- osm_query_filtered %>% 
        mutate(max_speed = case_when(mph == TRUE ~ maxspeed * 1.609344,
                                    mph == FALSE ~ maxspeed)) %>% 
      select(-maxspeed) %>% 
      rename(maxspeed = max_speed)
    
    osm_query_maxspeed <- osm_query_filtered %>% select(maxspeed) %>% 
      st_drop_geometry() %>% drop_na() %>% max()
    
    # Retrieve road types and set as factor based on capacity -----------------
    osm_query_filtered$highway <- factor(osm_query_filtered$highway, 
                                  levels = c('residential', 'unclassified', 
                                               'tertiary', 'secondary', 
                                               'primary', 'trunk', 'motorway'))
    osm_query_type <- osm_query_filtered %>% select(highway) %>% 
      st_drop_geometry() %>% drop_na() %>% slice_max(highway) %>% unique() %>% 
      deframe()
    
    
    #--------------------------------------------------------------------------
    # Add entries to entry table
    entry_table <- entry_table %>% add_row(uid = i, 
                          lanes = osm_query_lanes, 
                          maxspeed = osm_query_maxspeed,
                          type = osm_query_type)
   # print(paste('Completed:', x))
    
    #--------------------------------------------------------------------------
  } else {
    # Create empty entry if no useable data is present.
    entry_table <- entry_table %>% add_row(uid = i, 
                          lanes = NA, 
                          maxspeed = NA,
                          type = NA)
   # print(paste('No useable data at:', x, '...', 'Proceeding!'))
  }
  #rm(osm_colnames, query_coords, q_lon, q_lat, osm_query, 
 #    osm_query_filtered, osm_query_lanes, osm_query_maxspeed, osm_query_type)
}
return(entry_table)  
}

```


```{r}


divided_dataset <- tibble(x = seq(1:18135029))



num_groups = 10

divided_dataset <- divided_dataset %>% mutate(grouping = (row_number()-1) %/% (n()/num_groups)) %>% 
   group_by(grouping) %>% 
  summarize(min_x = min(x), max_x = max(x)) %>% select(-grouping)


sequence_start = pull(divided_dataset, min_x)

sequence_end = pull(divided_dataset, max_x)

###


plan(multisession, workers = 10)
registerDoFuture()


combined_table <- foreach(a = sequence_start, 
                          b = sequence_end, 
                          .combine = rbind) %dopar% {
  
  iterate_table <- osm_extracter(startpoint = a, endpoint = b, 
                                 centroids = overlay_centroids)
}




```

```{r}



###

divided_dataset <- tibble(x = seq(1:18135029))

num_groups = 10

divided_dataset <- divided_dataset %>% mutate(grouping = (row_number()-1) %/% (n()/num_groups)) %>% 
   group_by(grouping) %>% 
  summarize(min_x = min(x), max_x = max(x)) %>% select(-grouping)


sequence_start = pull(divided_dataset, min_x)

sequence_end = pull(divided_dataset, max_x)



###

na_data <- read_sf('/home/steven/Downloads/na_highway_filtered_final.gpkg')

na_data <- na_data %>% select(-waterway, -aerialway, -barrier, -man_made, -z_order) %>% rowid_to_column('grouping_id') %>% 
  mutate(group = case_when(grouping_id >= sequence_start[1] & grouping_id <= sequence_end[1] ~ 1,
                           grouping_id >= sequence_start[2] & grouping_id <= sequence_end[2] ~ 2,
                           grouping_id >= sequence_start[3] & grouping_id <= sequence_end[3] ~ 3,
                           grouping_id >= sequence_start[4] & grouping_id <= sequence_end[4] ~ 4,
                           grouping_id >= sequence_start[5] & grouping_id <= sequence_end[5] ~ 5,
                           grouping_id >= sequence_start[6] & grouping_id <= sequence_end[6] ~ 6,
                           grouping_id >= sequence_start[7] & grouping_id <= sequence_end[7] ~ 7,
                           grouping_id >= sequence_start[8] & grouping_id <= sequence_end[8] ~ 8,
                           grouping_id >= sequence_start[9] & grouping_id <= sequence_end[9] ~ 9,
                           grouping_id >= sequence_start[10] & grouping_id <= sequence_end[10] ~ 10)) %>% select(-grouping_id)

for (i in 1:10)  {
 selection <- na_data %>% filter(group == i)
 filename <- paste0('data_directory/na_highway_subset_', as.character(i), '.gpkg')
 write_sf(selection, filename)
 print(paste('Written:', filename))
}

```


```{r}

na_table_total <- tibble(osm_id = character(),
                         type = factor(levels = c('residential', 'unclassified', 
                                               'tertiary', 'secondary', 
                                               'primary', 'trunk', 'motorway')),
                         max_speed = numeric(),
                         lanes = numeric(),
                         lon = numeric(),
                         lat = numeric())

highway_data_list = list.files('data_directory/', 
                      pattern = 'na_highway_subset_*',
                      full.names = TRUE,
                      recursive = TRUE)


for (i in 1:length(highway_data_list)) {
  
  na_subset <- read_sf(highway_data_list[i])
  
  na_ids <- na_subset %>% select(osm_id)

  na_lanes <- na_subset %>% filter(grepl('lanes', other_tags)) %>% 
    separate_longer_delim(other_tags, delim = ',') %>%  
    filter(grepl('"lanes"=>', other_tags)) %>%  
    mutate(across('other_tags', str_replace, '"lanes"=>', '')) %>% 
    mutate(across('other_tags', str_replace, '"', '')) %>% 
    mutate(across('other_tags', str_replace, '"', '')) %>% 
    rename(lanes = other_tags) %>% select(osm_id, lanes) %>% 
    st_drop_geometry()

  na_semicolon <- na_lanes 

  na_semicolon$lanes <- sub("\\;.*", "", na_semicolon$lanes)

  na_lanes_filtered <- na_lanes %>% filter(!grepl(';', lanes))

  na_lanes <- rbind(na_semicolon, na_lanes_filtered)

  na_lanes$lanes <- as.numeric(na_lanes$lanes)

  ###

  na_maxspeed <- na_subset %>% filter(grepl('maxspeed', other_tags)) %>% 
    separate_longer_delim(other_tags, delim = ',') %>% 
    filter(grepl('"maxspeed"=>', other_tags)) %>% 
    mutate(across('other_tags', str_replace, '"maxspeed"=>', '')) %>% 
    rename(max_speed = other_tags)  %>% 
    filter(!grepl('unposted', max_speed)) %>% 
    filter(!grepl('slow', max_speed)) %>% 
    filter(!grepl('implicit', max_speed)) %>% 
    filter(!grepl('default', max_speed)) %>% 
    select(osm_id, max_speed) %>% 
    st_drop_geometry()

  na_maxspeed_kmh <- na_maxspeed %>% filter(!grepl('mph', max_speed)) %>% 
    mutate(across('max_speed', str_replace, '"', '')) %>% 
    mutate(across('max_speed', str_replace, '"', ''))

  na_maxspeed_kmh$max_speed <- gsub("[^0-9.-]", NA, na_maxspeed_kmh$max_speed)

  na_maxspeed_kmh <- na_maxspeed_kmh %>% drop_na()

  na_maxspeed_mph <- na_maxspeed %>% filter(grepl('mph', max_speed)) %>% 
    mutate(across('max_speed', str_replace, ' mph', ''))

  na_maxspeed_mph_filtered <- na_maxspeed_mph %>% filter(!grepl(';', max_speed))

  na_maxspeed_mph_semicolon <- na_maxspeed_mph %>% filter(grepl(';', max_speed))

  na_maxspeed_mph_semicolon$max_speed <- sub("\\;.*", "", na_maxspeed_mph_semicolon$max_speed)

  na_maxspeed_mph_semicolon <- na_maxspeed_mph_semicolon %>%
    mutate(across('max_speed', str_replace, '"', ''))

  na_maxspeed_mph <- rbind(na_maxspeed_mph_filtered, na_maxspeed_mph_semicolon)

  na_maxspeed_mph <- na_maxspeed_mph %>% 
    mutate(across('max_speed', str_replace, '"', '')) %>% 
    mutate(across('max_speed', str_replace, '"', ''))

  na_maxspeed_mph$max_speed <- as.numeric(na_maxspeed_mph$max_speed)

  na_maxspeed_mph <- na_maxspeed_mph %>% 
    mutate(max_speed_kmh = max_speed*1.609344) %>% 
    select(osm_id, max_speed_kmh) %>% 
    rename(max_speed = max_speed_kmh)

  na_maxspeed_combined <- rbind(na_maxspeed_mph, na_maxspeed_kmh)

  na_maxspeed_combined <- na_maxspeed_combined %>% filter(max_speed > 120)

  ###

  na_type <- na_subset %>% select(osm_id, highway) %>% rename(type = highway)

  na_type$type <- factor(na_type$type, 
                                  levels = c('residential', 'unclassified', 
                                               'tertiary', 'secondary', 
                                               'primary', 'trunk', 'motorway'))

  na_type <- na_type %>% st_drop_geometry()

  na_data_final <- reduce(list(na_ids, na_type, na_maxspeed_combined, na_lanes), 
                          dplyr::left_join, by = 'osm_id') %>% drop_na()

  na_table_int <- st_centroid(na_data_final) %>% 
    dplyr::mutate(lon = sf::st_coordinates(.)[,1],
                lat = sf::st_coordinates(.)[,2]) %>% 
    st_drop_geometry()
  
  na_table_total <- rbind(na_table_total, na_table_int)
  
  print(paste('Completed:', i))
  
}

rm(na_subset)

gc()

na_points_total <- st_as_sf(na_table_total, coords = c('lon', 'lat'), 
                            crs = 4326) %>% drop_na()

write_sf(na_points_total, 'data_directory/osm_points_final.gpkg')


```


```{r}

hexagon_selection <- read_sf('data_directory/2km_hexagon_selection.gpkg') %>% rowid_to_column()


na_points_total <- read_sf('data_directory/osm_points_final.gpkg') 

divided_dataset <- tibble(x = seq(1:5549984))

num_groups = 40

divided_dataset <- divided_dataset %>% mutate(grouping = (row_number()-1) %/% (n()/num_groups)) %>% 
   group_by(grouping) %>% 
  summarize(min_x = min(x), max_x = max(x)) %>% select(-grouping)


sequence_start = pull(divided_dataset, min_x)

sequence_end = pull(divided_dataset, max_x)

hexagon_selection <- hexagon_selection %>% mutate(group_id = case_when(
  rowid >= sequence_start[1] & rowid <= sequence_end[1] ~ 1,
  rowid >= sequence_start[2] & rowid <= sequence_end[2] ~ 2,
  rowid >= sequence_start[3] & rowid <= sequence_end[3] ~ 3,
  rowid >= sequence_start[4] & rowid <= sequence_end[4] ~ 4,
  rowid >= sequence_start[5] & rowid <= sequence_end[5] ~ 5,
  rowid >= sequence_start[6] & rowid <= sequence_end[6] ~ 6,
  rowid >= sequence_start[7] & rowid <= sequence_end[7] ~ 7,
  rowid >= sequence_start[8] & rowid <= sequence_end[8] ~ 8,
  rowid >= sequence_start[9] & rowid <= sequence_end[9] ~ 9,
  rowid >= sequence_start[10] & rowid <= sequence_end[10] ~ 10,
  rowid >= sequence_start[11] & rowid <= sequence_end[11] ~ 11,
  rowid >= sequence_start[12] & rowid <= sequence_end[12] ~ 12,
  rowid >= sequence_start[13] & rowid <= sequence_end[13] ~ 13,
  rowid >= sequence_start[14] & rowid <= sequence_end[14] ~ 14,
  rowid >= sequence_start[15] & rowid <= sequence_end[15] ~ 15,
  rowid >= sequence_start[16] & rowid <= sequence_end[16] ~ 16,
  rowid >= sequence_start[17] & rowid <= sequence_end[17] ~ 17,
  rowid >= sequence_start[18] & rowid <= sequence_end[18] ~ 18,
  rowid >= sequence_start[19] & rowid <= sequence_end[19] ~ 19,
  rowid >= sequence_start[20] & rowid <= sequence_end[20] ~ 20,
  rowid >= sequence_start[21] & rowid <= sequence_end[21] ~ 21,
  rowid >= sequence_start[22] & rowid <= sequence_end[22] ~ 22,
  rowid >= sequence_start[23] & rowid <= sequence_end[23] ~ 23,
  rowid >= sequence_start[24] & rowid <= sequence_end[24] ~ 24,
  rowid >= sequence_start[25] & rowid <= sequence_end[25] ~ 25,
  rowid >= sequence_start[26] & rowid <= sequence_end[26] ~ 26,
  rowid >= sequence_start[27] & rowid <= sequence_end[27] ~ 27,
  rowid >= sequence_start[28] & rowid <= sequence_end[28] ~ 28,
  rowid >= sequence_start[29] & rowid <= sequence_end[29] ~ 29,
  rowid >= sequence_start[30] & rowid <= sequence_end[30] ~ 30,
  rowid >= sequence_start[31] & rowid <= sequence_end[31] ~ 31,
  rowid >= sequence_start[32] & rowid <= sequence_end[32] ~ 32,
  rowid >= sequence_start[33] & rowid <= sequence_end[33] ~ 33,
  rowid >= sequence_start[34] & rowid <= sequence_end[34] ~ 34,
  rowid >= sequence_start[35] & rowid <= sequence_end[35] ~ 35,
  rowid >= sequence_start[36] & rowid <= sequence_end[36] ~ 36,
  rowid >= sequence_start[37] & rowid <= sequence_end[37] ~ 37,
  rowid >= sequence_start[38] & rowid <= sequence_end[38] ~ 38,
  rowid >= sequence_start[39] & rowid <= sequence_end[39] ~ 39,
  rowid >= sequence_start[40] & rowid <= sequence_end[40] ~ 40))

hexagon_simplified <- hexagon_selection %>% group_by(group_id) %>% summarize()

hexagon_grouped <- st_join(hexagon_selection, hexagon_simplified, join = st_intersects,
                             left = TRUE)

na_points_grouped <- st_join(na_points_total, hexagon_simplified, join = st_intersects,
                             left = TRUE)

write_sf(hexagon_grouped, 'data_directory/2km_hexagon_grouped.gpkg')

write_sf(na_points_grouped, 'data_directory/osm_points_grouped.gpkg')

###

osm_grid <- read_sf('data_directory/2km_hexagon_grouped.gpkg')
osm_points <- read_sf('data_directory/osm_points_grouped.gpkg')

###

osm_grid = hexagon_selection
osm_points = na_points_grouped

plan(multicore, workers = 8)
options(future.globals.maxSize = 2e+9)
registerDoFuture()


combined_table <- foreach(a = 1:40,
                          .combine = rbind) %dofuture% {
                            
      hexagon_filtered <- osm_grid %>% filter(group_id == a)
      na_points_filtered <- osm_points %>% filter(group_id == a)
      joined_points <- st_join(na_points_filtered, hexagon_filtered, 
                               left = TRUE,
                               join = st_intersects) %>% 
        st_drop_geometry()
      
      hexagon_sum <- joined_points %>% group_by(rowid) %>% 
        summarize_at(c('max_speed', 'type', 'lanes'),
                     max, na.rm = TRUE)
      return(hexagon_sum)
      }


```



```{r}

zm_bbox <- st_bbox(north_america_bbox)


buffer_plot <- ggplot() + geom_sf(data = land, fill = 'gray70', colour = 'gray15') +
  geom_sf(data = large_rivers, colour = 'gray60') +
  geom_sf(data = small_rivers, colour = 'gray60', alpha = 0.3) +
    geom_sf(data = large_lakes, fill = 'gray50', colour = 'gray15') +
  geom_sf(data = small_lakes, fill = 'gray50', colour = 'gray15') +
  geom_sf(data = zm_buffer_collected_test, aes(fill = buffer_dist)) +
  scale_fill_carto_d(palette = 'TealGrn', direction = -1, name = 'Buffer distance \n in km') +
  theme_dark(base_family = extrafont::choose_font('Cantarell Light'), 
               base_size = 12) +
      coord_sf(xlim = c(zm_bbox[[1]], zm_bbox[[3]]),
             ylim = c(zm_bbox[[2]], zm_bbox[[4]]), 
             expand = FALSE) 



```
